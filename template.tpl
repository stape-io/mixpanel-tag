___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Mixpanel",
  "brand": {
    "id": "github.com_stape-io",
    "displayName": "stape-io",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Utilizes Mixpanel server API for user and event tracking.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "token",
    "displayName": "Project Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "You can get the Project Token from \u003ca href\u003d\"https://mixpanel.com/settings/project\" target\u003d\"_blank\"\u003eproject settings\u003c/a\u003e.",
    "alwaysInSummary": true
  },
  {
    "type": "SELECT",
    "name": "type",
    "displayName": "Tag Type",
    "selectItems": [
      {
        "value": "track",
        "displayValue": "track"
      },
      {
        "value": "identify",
        "displayValue": "identify"
      },
      {
        "value": "alias",
        "displayValue": "alias"
      },
      {
        "value": "reset",
        "displayValue": "reset"
      },
      {
        "value": "profile-set",
        "displayValue": "set"
      },
      {
        "value": "profile-append",
        "displayValue": "append"
      },
      {
        "value": "profile-set-once",
        "displayValue": "set-once"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "track"
  },
  {
    "type": "CHECKBOX",
    "name": "serverEU",
    "checkboxText": "Route data to Mixpanel\u0027s EU servers",
    "simpleValueType": true,
    "defaultValue": false
  },
  {
    "type": "CHECKBOX",
    "name": "identifyAuto",
    "checkboxText": "Automatically handle customer distinct_id",
    "simpleValueType": true,
    "help": "Mixpanel server API optimized for stateless shared usage; e.g., in a web application, the same mixpanel instance is used across requests for all users. Rather than setting a distinct_id through identify() calls like Mixpanel client-side libraries (where a single Mixpanel instance is tied to a single user), this api requires you to pass the distinct_id with every tracking call.",
    "defaultValue": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "reset",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "identifyCustom",
    "displayName": "Distinct ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "identifyAuto",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "appendGroup",
    "displayName": "User Properties to append",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userPropertiesToAppend",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "User Property",
            "name": "propertyName",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "valueToAppend",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "profile-append",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "setGroup",
    "displayName": "User Properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userPropertiesTable",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "User Property",
            "name": "userProperty",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "profile-set",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "identifyGroup",
    "displayName": "Identify Options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "identifier",
        "displayName": "Identifier",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "aliasGroup",
    "displayName": "Alias Options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "alias",
        "displayName": "Alias",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": ""
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "alias",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "trackGroup",
    "displayName": "Track Options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "trackName",
        "displayName": "Event Name",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "trackCommonData",
        "checkboxText": "Send common data with request",
        "simpleValueType": true,
        "help": "Adds to track request user_agent, path, $current_url, $screen_width, $screen_height, $referrer, user ip, etc.",
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "trackFromVariable",
        "checkboxText": "Get parameters from variable",
        "simpleValueType": true
      },
      {
        "type": "SELECT",
        "name": "trackParametersObject",
        "displayName": "Parameters object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackFromVariable",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "trackParameters",
        "displayName": "Additional Parameters (Optional)",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "trackList",
        "displayName": "Parameters as lists",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "listName",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Values",
            "name": "listValues",
            "type": "TEXT"
          }
        ],
        "help": "List of parameters separated by comma sent as a Data Type  \u003d \"list\". For Example: tags: tag1,tag2,tag3"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "trackParametersRemove",
        "displayName": "Remove parameters from the request",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "TEXT"
          }
        ],
        "help": "Useful for removing common parameters like $current_url or ip"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "track",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "setOnceGroup",
    "displayName": "User Properties to Set Once",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userPropertiesToSetOnce",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "User Property",
            "name": "userProperty",
            "type": "TEXT",
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "profile-set-once",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getContainerVersion = require('getContainerVersion');
const logToConsole = require('logToConsole');
const getRequestHeader = require('getRequestHeader');
const generateRandom = require('generateRandom');
const parseUrl = require('parseUrl');
const makeString = require('makeString');
const Object = require('Object');
const makeNumber = require('makeNumber');
const getTimestamp = require('getTimestamp');

/**********************************************************************************************/

const postUrl = 'https://' + (data.serverEU ? 'api-eu.mixpanel.com' : 'api.mixpanel.com');
const containerVersion = getContainerVersion();
const isDebug = containerVersion.debugMode;
const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = getRequestHeader('trace-id');
const eventData = getAllEventData();

let cookieOptions = {
    domain: 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true,
    'max-age': 31536000, // 1 year
    httpOnly: false
};

if (data.type === 'track') {
    sendTrackRequest();
} else if (data.type === 'alias') {
    sendAliasRequest();
} else if (data.type === 'identify') {
    sendIdentifyRequest();
} else if (data.type === 'profile-set') {
    sendSetProfileRequest();
} else if (data.type === 'profile-append') {
    sendAppendProfileRequest();
} else if (data.type === 'profile-set-once') {
    sendSetOnceProfileRequest();
} else if (data.type === 'reset') {
    cookieOptions['max-age'] = 1;
    setCookie('stape_mixpanel_distinct_id', 'empty', cookieOptions);
    setCookie('stape_mixpanel_device_id', 'empty', cookieOptions);
    data.gtmOnSuccess();
    return;
}

/**********************************************************************************************/
// Vendor related functions

function sendAppendProfileRequest() {
    const propertiesToAppend = {};
    data.userPropertiesToAppend.forEach(row => {
        if (!propertiesToAppend[row.propertyName]) {
            propertiesToAppend[row.propertyName] = [];
        }
        propertiesToAppend[row.propertyName].push(row.valueToAppend);
    });

    const profileBody = {
        '$token': data.token,
        '$distinct_id': getDistinctId(),
        '$append': propertiesToAppend
    };

    const postUrlAppend = postUrl + '/engage#profile-list-append';

    if (isLoggingEnabled) {
        logToConsole(JSON.stringify({
            'Name': 'Mixpanel',
            'Type': 'Request',
            'TraceId': traceId,
            'EventName': 'Profile Append',
            'RequestMethod': 'POST',
            'RequestUrl': postUrlAppend,
            'RequestBody': profileBody,
        }));
    }

    sendHttpRequest(postUrlAppend, (statusCode, headers, body) => {
        if (isLoggingEnabled) {
            logToConsole(JSON.stringify({
                'Name': 'Mixpanel',
                'Type': 'Response',
                'TraceId': traceId,
                'EventName': 'Profile Append',
                'ResponseStatusCode': statusCode,
                'ResponseHeaders': headers,
                'ResponseBody': body,
            }));
        }

        if (statusCode >= 200 && statusCode < 400 && body && body === '1') {
            data.gtmOnSuccess();
        } else {
            data.gtmOnFailure();
        }
    }, {headers: {'Content-Type': 'application/json'}, method: 'POST'}, JSON.stringify([profileBody]));
}

function sendSetProfileRequest() {
    const userProperties = {};
    data.userPropertiesTable.forEach(row => {
        userProperties[row.userProperty] = row.value;
    });

    const profileBody = {
        '$token': data.token,
        '$distinct_id': getDistinctId(),
        '$ip': eventData.ip_override || eventData.ip,
        '$set': userProperties
    };

    const postUrlSet = postUrl + '/engage#profile-set';

    if (isLoggingEnabled) {
        logToConsole(JSON.stringify({
            'Name': 'Mixpanel',
            'Type': 'Request',
            'TraceId': traceId,
            'EventName': 'Profile Set',
            'RequestMethod': 'POST',
            'RequestUrl': postUrlSet,
            'RequestBody': profileBody,
        }));
    }

    sendHttpRequest(postUrlSet, (statusCode, headers, body) => {
        if (isLoggingEnabled) {
            logToConsole(JSON.stringify({
                'Name': 'Mixpanel',
                'Type': 'Response',
                'TraceId': traceId,
                'EventName': 'Profile Set',
                'ResponseStatusCode': statusCode,
                'ResponseHeaders': headers,
                'ResponseBody': body,
            }));
        }

        if (statusCode >= 200 && statusCode < 400 && body && body === '1') {
            data.gtmOnSuccess();
        } else {
            data.gtmOnFailure();
        }
    }, {headers: {'Content-Type': 'application/json'}, method: 'POST'}, JSON.stringify([profileBody]));
}

function sendSetOnceProfileRequest() {
    const userProperties = {};
    data.userPropertiesToSetOnce.forEach(row => {
        userProperties[row.userProperty] = row.value;
    });

    const profileBody = {
        '$token': data.token,
        '$distinct_id': getDistinctId(),
        '$ip': eventData.ip_override || eventData.ip,
        '$set_once': userProperties
    };

    const postUrlSetOnce = postUrl + '/engage#profile-set-once';

    if (isLoggingEnabled) {
        logToConsole(JSON.stringify({
            'Name': 'Mixpanel',
            'Type': 'Request',
            'TraceId': traceId,
            'EventName': 'Profile Set Once',
            'RequestMethod': 'POST',
            'RequestUrl': postUrlSetOnce,
            'RequestBody': profileBody,
        }));
    }

    sendHttpRequest(postUrlSetOnce, (statusCode, headers, body) => {
        if (isLoggingEnabled) {
            logToConsole(JSON.stringify({
                'Name': 'Mixpanel',
                'Type': 'Response',
                'TraceId': traceId,
                'EventName': 'Profile Set Once',
                'ResponseStatusCode': statusCode,
                'ResponseHeaders': headers,
                'ResponseBody': body,
            }));
        }

        if (statusCode >= 200 && statusCode < 400 && body && body === '1') {
            data.gtmOnSuccess();
        } else {
            data.gtmOnFailure();
        }
    }, {headers: {'Content-Type': 'application/json'}, method: 'POST'}, JSON.stringify([profileBody]));
}

function sendTrackRequest() {
    let postBody = {
        properties: {}
    };

    if (data.trackCommonData) {
        postBody = trackCommonData(postBody);
    }

    if (data.trackFromVariable && data.trackParametersObject) {
        for (let key in data.trackParametersObject) {
            postBody.properties[key] = data.trackParametersObject[key];
        }
    }

    if (data.trackParameters) {
        data.trackParameters.forEach(d => {
            postBody.properties[d.name] = d.value;
        });
    }

    if (data.trackList) {
        data.trackList.forEach(d => {
            // Check if listValues is a string and have commas
            if (typeof d.listValues === 'string' && d.listValues.indexOf(',') !== -1) {
                // Convert a string to an array of strings, removing whitespace characters and dividing by commas
                postBody.properties[d.listName] = d.listValues.split(',').map(tag => tag.trim());
            } else {
                // If it is not a comma-delimited string, assign the value of listValues unchanged
                postBody.properties[d.listName] = d.listValues;
            }
        });
    }


    if (data.trackParametersRemove) {
        data.trackParametersRemove.forEach(d => {
            Object.delete(postBody.properties, d.name);
        });
    }

    sendRequest(data.trackName, postBody);
}

function sendAliasRequest() {
    sendRequest('$create_alias', {
        properties: {
            alias: data.alias
        }
    });
}

function sendIdentifyRequest() {
    sendRequest('$identify', {
        properties: {
            '$identified_id': data.identifier,
            '$anon_id': getDistinctId()
        }
    });
}

function sendRequest(eventName, postBody) {
    postBody.event = eventName;

    if (!postBody.properties) postBody.properties = {};
    postBody.properties.token = data.token;

    if (data.type !== 'identify') {
        postBody.properties.distinct_id = getDistinctId();
        postBody.properties['$device_id'] = getDeviceId(postBody.properties.distinct_id);

        if (data.identifyAuto) setDistinctIdCookies(postBody.properties.distinct_id, postBody.properties['$device_id']);
    }

    const postUrl = 'https://' + (data.serverEU ? 'api-eu.mixpanel.com' : 'api.mixpanel.com') + '/track?verbose=1';
    postBody = [postBody];

    if (isLoggingEnabled) {
        logToConsole(JSON.stringify({
            'Name': 'Mixpanel',
            'Type': 'Request',
            'TraceId': traceId,
            'EventName': eventName,
            'RequestMethod': 'POST',
            'RequestUrl': postUrl,
            'RequestBody': postBody,
        }));
    }

    sendHttpRequest(postUrl, (statusCode, headers, body) => {
        if (isLoggingEnabled) {
            logToConsole(JSON.stringify({
                'Name': 'Mixpanel',
                'Type': 'Response',
                'TraceId': traceId,
                'EventName': eventName,
                'ResponseStatusCode': statusCode,
                'ResponseHeaders': headers,
                'ResponseBody': body,
            }));
        }

        // Because of ?verbose=1
        let parsedBody;
        if (body) parsedBody = JSON.parse(body);

        if (statusCode >= 200 && statusCode < 400 && parsedBody && parsedBody.status === 1) {
            data.gtmOnSuccess();
        } else {
            data.gtmOnFailure();
        }
    }, {headers: {'Content-Type': 'application/json'}, method: 'POST'}, JSON.stringify(postBody));
}

function getDistinctId() {
    if (!data.identifyAuto) return data.identifyCustom;

    let mpData = getCookieValues('mp_' + data.token + '_mixpanel')[0];
    if (mpData) return JSON.parse(mpData).distinct_id;

    let distinctIdCookie = getCookieValues('stape_mixpanel_distinct_id')[0];
    if (distinctIdCookie) return distinctIdCookie;

    return UUID();
}

function getDeviceId(distinctId) {
    if (!data.identifyAuto) return data.identifyCustom;

    let mpData = getCookieValues('mp_' + data.token + '_mixpanel')[0];
    if (mpData) return JSON.parse(mpData)['$device_id'];

    let distinctIdCookie = getCookieValues('stape_mixpanel_device_id')[0];
    if (distinctIdCookie) return distinctIdCookie;

    return distinctId;
}

function setDistinctIdCookies(distinctId, deviceId) {
    setCookie('stape_mixpanel_distinct_id', makeString(distinctId), cookieOptions);
    setCookie('stape_mixpanel_device_id', makeString(deviceId), cookieOptions);
}

function trackCommonData(postBody) {
    postBody = {
        properties: {
            'ip': eventData.ip_override || eventData.ip,
            'mp_lib': 'stape',
            '$lib_version': '1.0.0',
        }
    };

    if (eventData.user_agent) postBody.properties.user_agent = eventData.user_agent;
    if (eventData.page_path) postBody.properties.path = eventData.page_path;
    if (eventData.page_location) postBody.properties['$current_url'] = eventData.page_location;
    if (eventData.screen_resolution) postBody.properties['$screen_width'] = eventData.screen_resolution.split('x')[0];
    if (eventData.screen_resolution) postBody.properties['$screen_height'] = eventData.screen_resolution.split('x')[1];
    if (eventData.page_referrer) postBody.properties['$referrer'] = eventData.page_referrer;
    if (eventData.page_referrer) postBody.properties['$referring_domain'] = parseUrl(eventData.page_referrer).hostname;

    const url = eventData.page_location || getRequestHeader('referer');
    const urlParsed = parseUrl(url);

    // https://docs.mixpanel.com/docs/tracking-methods/sdks/javascript#track-utm-tags
    if (urlParsed && urlParsed.searchParams.utm_source) postBody.properties['utm_source'] = urlParsed.searchParams.utm_source;
    if (urlParsed && urlParsed.searchParams.utm_campaign) postBody.properties['utm_campaign'] = urlParsed.searchParams.utm_campaign;
    if (urlParsed && urlParsed.searchParams.utm_medium) postBody.properties['utm_medium'] = urlParsed.searchParams.utm_medium;
    if (urlParsed && urlParsed.searchParams.utm_term) postBody.properties['utm_term'] = urlParsed.searchParams.utm_term;
    if (urlParsed && urlParsed.searchParams.utm_content) postBody.properties['utm_content'] = urlParsed.searchParams.utm_content;
    if (urlParsed && urlParsed.searchParams.utm_id) postBody.properties['utm_id'] = urlParsed.searchParams.utm_id;
    if (urlParsed && urlParsed.searchParams.utm_source_platform) postBody.properties['utm_source_platform'] = urlParsed.searchParams.utm_source_platform;
    if (urlParsed && urlParsed.searchParams.utm_campaign_id) postBody.properties['utm_campaign_id'] = urlParsed.searchParams.utm_campaign_id;
    if (urlParsed && urlParsed.searchParams.utm_creative_format) postBody.properties['utm_creative_format'] = urlParsed.searchParams.utm_creative_format;
    if (urlParsed && urlParsed.searchParams.utm_marketing_tactic) postBody.properties['utm_marketing_tactic'] = urlParsed.searchParams.utm_marketing_tactic;

    if (urlParsed && urlParsed.searchParams.dclid) postBody.properties['dclid'] = urlParsed.searchParams.dclid;
    if (urlParsed && urlParsed.searchParams.fbclid) postBody.properties['fbclid'] = urlParsed.searchParams.fbclid;
    if (urlParsed && urlParsed.searchParams.gclid) postBody.properties['gclid'] = urlParsed.searchParams.gclid;
    if (urlParsed && urlParsed.searchParams.ko_click_id) postBody.properties['ko_click_id'] = urlParsed.searchParams.ko_click_id;
    if (urlParsed && urlParsed.searchParams.li_fat_id) postBody.properties['li_fat_id'] = urlParsed.searchParams.li_fat_id;
    if (urlParsed && urlParsed.searchParams.msclkid) postBody.properties['msclkid'] = urlParsed.searchParams.msclkid;
    if (urlParsed && urlParsed.searchParams.sccid) postBody.properties['sccid'] = urlParsed.searchParams.sccid;
    if (urlParsed && urlParsed.searchParams.ttclid) postBody.properties['ttclid'] = urlParsed.searchParams.ttclid;
    if (urlParsed && urlParsed.searchParams.twclid) postBody.properties['twclid'] = urlParsed.searchParams.twclid;
    if (urlParsed && urlParsed.searchParams.wbraid) postBody.properties['wbraid'] = urlParsed.searchParams.wbraid;

    if (postBody.properties['$referrer']) {
        let searchEngine = getSearchEngine(postBody.properties['$referrer']);

        if (searchEngine) {
            let searchEngineKeyword = null;

            if (urlParsed) {
                searchEngineKeyword = searchEngine !== 'yahoo' ? urlParsed.searchParams.q : urlParsed.searchParams.p;
            }

            postBody.properties['$search_engine'] = searchEngine;
            if (searchEngineKeyword) postBody.properties['mp_keyword'] = searchEngineKeyword;
        }
    }

    if (postBody.properties.user_agent) {
        let os = getOS(postBody.properties.user_agent);
        let device = getDevice(postBody.properties.user_agent);
        let browser = getBrowser(postBody.properties.user_agent);
        let browserVersion = getBrowserVersion(postBody.properties.user_agent, browser);

        if (os) postBody.properties['$os'] = os;
        if (device) postBody.properties['$device'] = device;
        if (browser) postBody.properties['$browser'] = browser;
        if (browserVersion) postBody.properties['$browser_version'] = browserVersion;
    }

    if (!data.trackParametersRemove || !data.trackParametersRemove.some(el => el.name === '$initial_referrer')) {
        let initialReferrer = getCookieValues('stape_mixpanel_initial_referrer')[0];
        if (initialReferrer) postBody.properties['$initial_referrer'] = initialReferrer;
        if (!initialReferrer) {
            postBody.properties['$initial_referrer'] = postBody.properties['$referrer'] ? postBody.properties['$referrer'] : 'direct';
            setCookie('stape_mixpanel_initial_referrer', makeString(postBody.properties['$initial_referrer']), cookieOptions);
        }
    }

    if (postBody.properties['$initial_referrer'] && postBody.properties['$initial_referrer'] !== 'direct') postBody.properties['$initial_referring_domain'] = parseUrl(postBody.properties['$initial_referrer']).hostname;

    return postBody;
}

function getOS(userAgent) {
    if (userAgent.toLowerCase().match('windows') && userAgent.match('Phone')) return 'Windows Mobile';
    else if (userAgent.toLowerCase().match('windows')) return 'Windows';
    else if (userAgent.match('(iPhone|iPad|iPod)')) return 'iOS';
    else if (userAgent.match('Android')) return 'Android';
    else if (userAgent.match('(BlackBerry|PlayBook|BB10)')) return 'BlackBerry';
    else if (userAgent.match('Mac')) return 'Mac OS X';
    else if (userAgent.match('Linux')) return 'Linux';

    return '';
}

function getDevice(userAgent) {
    if (userAgent.match('iPad')) return 'iPad';
    else if (userAgent.match('iPod')) return 'iPod Touch';
    else if (userAgent.match('iPhone')) return 'iPhone';
    else if (userAgent.toLowerCase().match('(blackberry|playbook|bb10)')) return 'BlackBerry';
    else if (userAgent.toLowerCase().match('windows phone')) return 'Windows Phone';
    else if (userAgent.match('Android')) return 'Android';

    return '';
}

function getBrowser(userAgent) {
    if (userAgent.match('Opera Mini')) return 'Opera Mini';
    if (userAgent.match('Opera')) return 'Opera';
    if (userAgent.toLowerCase().match('(BlackBerry|PlayBook|BB10)')) return 'BlackBerry';
    if (userAgent.match('FBIOS')) return 'Facebook Mobile';
    if (userAgent.match('Chrome')) return 'Chrome';
    if (userAgent.match('CriOS')) return 'Chrome iOS';
    if (userAgent.match('Apple') && userAgent.match('Mobile')) return 'Mobile Safari';
    if (userAgent.match('Apple')) return 'Safari';
    if (userAgent.match('Android')) return 'Android Mobile';
    if (userAgent.match('Konqueror')) return 'Konqueror';
    if (userAgent.match('Firefox')) return 'Firefox';
    if (userAgent.match('MSIE') || userAgent.match('Trident')) return 'Internet Explorer';
    if (userAgent.match('Gecko')) return 'Mozilla';

    return '';
}

function getBrowserVersion(userAgent, browser) {
    const versionRegexs = {
        'Internet Explorer Mobile': 'rv:([0-9]+(.[0-9]+)?)',
        'Microsoft Edge': 'Edge?/([0-9]+(.[0-9]+)?)',
        'Chrome': 'Chrome/([0-9]+(.[0-9]+)?)',
        'Chrome iOS': 'CriOS/([0-9]+(.[0-9]+)?)',
        'UC Browser' : '(UCBrowser|UCWEB)/([0-9]+(.[0-9]+)?)',
        'Safari': 'Version/([0-9]+(.[0-9]+)?)',
        'Mobile Safari': 'Version/([0-9]+(.[0-9]+)?)',
        'Opera': '(Opera|OPR)/([0-9]+(.[0-9]+)?)',
        'Firefox': 'Firefox/([0-9]+(.[0-9]+)?)',
        'Firefox iOS': 'FxiOS/([0-9]+(.[0-9]+)?)',
        'Konqueror': 'Konqueror:([0-9]+(.[0-9]+)?)',
        'BlackBerry': 'BlackBerry ([0-9]+(.[0-9]+)?)',
        'Android Mobile': 'android.([0-9]+(.[0-9]+)?)',
        'Samsung Internet': 'SamsungBrowser/([0-9]+(.[0-9]+)?)',
        'Internet Explorer': '(rv:|MSIE )([0-9]+(.[0-9]+)?)',
        'Mozilla': 'rv:([0-9]+(.[0-9]+)?)'
    };

    let regex = versionRegexs[browser];
    if (regex === undefined) {
        return null;
    }

    let matches = userAgent.match(regex);
    if (!matches) {
        return null;
    }

    return makeNumber(matches[matches.length - 2]);
}

function getSearchEngine(referrer) {
    if (referrer.search('https?://(.*)google.([^/?]*)') === 0) return 'google';
    else if (referrer.search('https?://(.*)bing.com') === 0) return 'bing';
    else if (referrer.search('https?://(.*)yahoo.com') === 0) return 'yahoo';
    else if (referrer.search('https?://(.*)duckduckgo.com') === 0) return 'duckduckgo';

    return null;
}

/**********************************************************************************************/
// Helpers

function random() {
    return generateRandom(1000000000000000, 10000000000000000)/10000000000000000;
}
  
function UUID() {
    function s(n) { return h((random() * (1<<(n<<2)))^getTimestamp()).slice(-n); }
    function h(n) { return (n|0).toString(16); }
    return  [
        s(4) + s(4), s(4),
        '4' + s(3),
        h(8|(random()*4)) + s(3),
        getTimestamp().toString(16).slice(-10) + s(2)
    ].join('-');
}

function determinateIsLoggingEnabled() {
    if (!data.logType) {
        return isDebug;
    }

    if (data.logType === 'no') {
        return false;
    }

    if (data.logType === 'debug') {
        return isDebug;
    }

    return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stape_mixpanel_distinct_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stape_mixpanel_device_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stape_mixpanel_initial_referrer"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.mixpanel.com/*"
              },
              {
                "type": 1,
                "string": "https://api-eu.mixpanel.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 15/06/2022, 17:43:17


